<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PMDR</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <script>

      class Timer {
        constructor() {
          this.totalTime =  0;
          this.elapsedTime = 0;
          this.handleOnEnd = null;
          this.isRunning = false;
          this.tickFrequency = 500;
          this.tick = setInterval(this.onRefresh, this.tickFrequency);
        }

        onRefresh = () => {
          if (this.isRunning) {
            this.elapsedTime += this.tickFrequency; 
            if (this.elapsedTime >= this.totalTime) {
              this.elapsedTime = this.totalTime;
              this.pause();
              if (this.handleOnEnd) {
                this.handleOnEnd();
              }
            }
          }
        }

        set(totalTime, handleOnEnd) {
          this.totalTime = totalTime * 1000;
          this.elapsedTime = 0;
          this.handleOnEnd = handleOnEnd;
          this.isRunning = false;
        }

        run() {
          this.isRunning = true;
        }

        pause() {
          this.isRunning = false;
        }

        getRemainedTime() {
          return (this.totalTime - this.elapsedTime);
        }
      }

      // UI
      function createImages() {
        const faviconSize = 16;

        let canvas = document.createElement('canvas');
        canvas.height = faviconSize;
        canvas.width = faviconSize;

        let context = canvas.getContext('2d');        
        context.fillStyle = "#" + Color.task;
        context.fillRect(0, 0, faviconSize, faviconSize);

        imageTask = canvas.toDataURL('image/png');

        context.fillStyle = "#" + Color.break;
        context.fillRect(0, 0, faviconSize, faviconSize);

        imageBreak = canvas.toDataURL('image/png');
      }

      function setIconColor(stage) {
        let favicon = document.getElementById('favicon');
        if (!favicon) {
          favicon = document.createElement('link');
        }
        favicon.id = "favicon"
        favicon.rel = "icon"
        document.head.appendChild(favicon);

        if (stage === Stage.task) {
          favicon.href = imageTask;
        }
        else {
          favicon.href = imageBreak;
        }
      }

      function setTitle(text) {
        document.title = text;
      }

      function checkPermissionNotification() {
        if (!("Notification" in window)) {
          alert("This browser does not support desktop notification");
        }
        else if (Notification.permission !== "granted") {
          Notification.requestPermission();
        }
      }

      function updateTitle() {
        const time = msInPrintable(timer.getRemainedTime());
        let title = time;
        title += " " + "(" + cycleNumber + "/" + maxCycles + ")"
        if (state !== State.run) {
          title += " [P]";
        }
        setTitle(title);
      }

      function updateIcon() {
        setIconColor(stage);
      }

      function msInPrintable(timeInMS) {
        const date = new Date(timeInMS).toISOString().slice(14,19); 
        return date;
      }

      function launchTimer(duration) {
        timer.set(duration * 60, onDeadline);
        timer.run();
      }

      function updateStage() {
        if (stage === Stage.task) {
          stage = Stage.break;
          launchTimer(Duration.break);
        }
        else {
          cycleNumber = cycleNumber + 1;
          if (cycleNumber <= maxCycles) {
            stage = Stage.task;
            launchTimer(Duration.task);
          }
          else {
            reset(Stage.task);
            cycleNumber = 1;
          }
        }
      }

      function timeForStage(stage) {
        if (stage === Stage.task) {
          return Duration.task;
        }
        else {
          return Duration.break;
        }
      }

      function reset(stageToReset) {
        timer.set(timeForStage(stageToReset) * 60, onDeadline);
        stage = stageToReset;
        state = State.pause;
        onRefresh();
      }

      onDeadline = () => {
        let title = "";
        if (stage == Stage.task) {
          title = "Break";
          icon = imageBreak;
        }
        else {
          icon = imageTask;
          if (cycleNumber == maxCycles) {
            title = "End of " + maxCycles + " cycles";
          }
          else {
            title = "Task";
          }
        }

        new Notification(title, {icon: icon});
        updateStage();
      }

      onRefresh = () => {
        updateTitle();
        updateIcon();
      }

      // CONST
      const Stage = Object.freeze({"task":1, "break":2})
      const State = Object.freeze({"run":1, "pause":2})
      const Color = Object.freeze({"task":"ff0000", "break":"00ff00"})
      const Duration = Object.freeze({"task":0.1, "break":0.2})
      const maxCycles = 4;

      // MAIN
      function main() {
        checkPermissionNotification();
        createImages();

        timer = new Timer();
        cycleNumber = 1;

        reset(Stage.task);

        tick = setInterval(onRefresh, 500);
      }

      // EVENT MAPPING
      window.onkeyup = function(event) {
        const key = event.code;
        if (key == "Space") {
          if (state === State.pause) {
            timer.run();
            state = State.run;
          }
          else {
            timer.pause();
            state = State.pause;
          }
        }
        else if (key == "Digit1") {
          cycleNumber = 1;
        }
        else if (key == "Digit2") {
          cycleNumber = 2;
        }
        else if (key == "Digit3") {
          cycleNumber = 3;
        }
        else if (key == "Digit4") {
          cycleNumber = 4;
        }
        else if (key == "KeyR" || key == "KeyT") {
          reset(Stage.task);
        }
        else if (key == "KeyP" || key == "KeyB") {
          reset(Stage.break);
        }
      }

      window.onload = function() {
        main();
      }

    </script>
  </body>
</html>