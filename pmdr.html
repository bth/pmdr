<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PMDR</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <script>

      class Timer {
        constructor(totalTime, handleOnEnd) {
          this.totalTime = totalTime * 1000;
          this.elapsedTime = 0;
          this.handleOnEnd = handleOnEnd;
          this.isRunning = false;
          this.tickFrequency = 500;
          this.tick = setInterval(this.onRefresh, this.tickFrequency);
        }

        onRefresh = () => {
          if (this.isRunning) {
            this.elapsedTime += this.tickFrequency; 
            if (this.elapsedTime >= this.totalTime) {
              clearInterval(this.tick);
              if (this.handleOnEnd) {
                this.handleOnEnd();
              }
            }
          }
        }

        run() {
          this.isRunning = true;
        }

        pause() {
          this.isRunning = false;
        }

        getRemainedTime() {
          return (this.totalTime - this.elapsedTime);
        }
      }

      function setIconColor(color) {
        let favicon = document.getElementById('favicon');
        if (!favicon) {
          favicon = document.createElement('link');
        }
        favicon.id = "favicon"
        favicon.rel = "icon"
        document.head.appendChild(favicon);
        const faviconSize = 16;

        let canvas = document.createElement('canvas');
        canvas.height = faviconSize;
        canvas.width = faviconSize;

        let context = canvas.getContext('2d');        
        context.fillStyle = "#" + (color ? color : "ffffff");
        context.fillRect(0, 0, faviconSize, faviconSize);

        favicon.href = canvas.toDataURL('image/png');
      }

      function setTitle(text) {
        document.title = text;
      }

      function sendNotification() {
        var notification = new Notification("Hi there!");
      }

      function checkPermissionNotification() {
        if (!("Notification" in window)) {
          alert("This browser does not support desktop notification");
        }
        else if (Notification.permission !== "granted") {
          Notification.requestPermission();
        }
      }

      function onDeadline() {
        console.log("onDeadline");
      }

      onRefresh = () => {
        updateTitle();
        updateIcon();
      }

      function updateTitle() {
        setTitle(msInPrintable(timer.getRemainedTime()));
      }

      function updateIcon() {
        if(state === State.task) {
          setIconColor("ff0000");  
        }
      }

      function msInPrintable(timeInMS) {
        const date = new Date(timeInMS).toISOString().slice(14,19); 
        return date;
      }

      // ENUM
      const State = Object.freeze({"task":1, "break":2})

      // MAIN
      function main() {
        setIconColor("ffffff");
        //setIconColor("00ff00");
        setTitle("00:00");
        checkPermissionNotification();

        state = State.task;

        tick = setInterval(onRefresh, 1000);

        timer = new Timer(10, onDeadline);
      }

      // EVENT MAPPING
      window.onkeyup = function(event) {
        const key = event.code;
        if (key == "Space") {
          timer.run();
        }
      }

      window.onload = function() {
        main();
      }

    </script>
  </body>
</html>